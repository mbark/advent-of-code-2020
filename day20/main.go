package main

import (
	"fmt"
	"math"
	"strconv"
	"strings"

	"github.com/mbark/advent-of-code-2020/util"
)

var input = `
Tile 1759:
.##.#..#..
..........
..#..#...#
##....####
###.##.##.
.#.#.#..#.
......#..#
##.....#..
..........
.##....#..

Tile 3803:
#.#.#.#.#.
#.........
#.....#...
#...#..#.#
#....#....
#..#.#...#
.##.#.##.#
#........#
#..#...#..
..#####.#.

Tile 2351:
......###.
##...##.##
.........#
..#.#.....
....#.##..
#.#.#.#.##
.##.#.##.#
....#...##
#..#...###
#.##...##.

Tile 2467:
#####.#.##
#........#
#.#....###
.......##.
....#....#
#.........
.......#.#
##.#..#..#
.#....#.##
..#....###

Tile 1933:
##.....###
#.#......#
....#...##
#.###.....
#.##.#..#.
....#....#
....##....
##........
#..##....#
.#.#.#...#

Tile 2971:
#.#.#.#..#
.........#
......#..#
##...#....
...###....
#....##...
.....#.#..
#....#.#.#
#.......#.
.###...#.#

Tile 2731:
.....#####
..##......
.......##.
.#........
#..#.#....
..........
#..##.#...
.#..###...
#.#..#....
..#.#.....

Tile 2423:
.####.#...
#.##.#...#
.....##...
##........
..#..#..##
#...######
....#...##
.....##...
...#...###
##.#..###.

Tile 1877:
.#...##..#
#..##....#
#.##......
...#......
.#........
#........#
#.....##.#
#.....##..
.........#
..####.#..

Tile 3461:
....##.##.
....##....
###......#
#.#...#...
#........#
.##..#.#.#
#.....#.#.
#.......#.
#........#
#.#.##.###

Tile 2137:
##.#.#...#
#..#.##..#
.##......#
#..#.#...#
###.#....#
#........#
#....#..#.
#...##.##.
...#.###..
##...#...#

Tile 2647:
##.##..#..
......#..#
.....#....
##......##
#.#.#..###
##.......#
#...###...
##...##..#
.....#....
###....##.

Tile 3253:
......#.#.
#.......#.
##..##....
#.#.##...#
.....#...#
...#..#..#
#.....#...
.#...#....
.#..#.##..
.###...##.

Tile 1409:
.###.###.#
#..#.##.##
........##
.###......
#####.####
..#..#.#.#
..#...##.#
..##..#.##
....#....#
####.....#

Tile 2503:
###.....##
.....#..#.
#...##....
.##..##..#
...#...#.#
.#..#.#...
#...#...##
#.........
##...#...#
...#....#.

Tile 1879:
.######.##
......#..#
..#.#..##.
..........
#..#.....#
.##.......
#.......##
..........
.........#
#.#.#.##..

Tile 3739:
#..#.#....
#.....#...
#.........
##....#..#
###..##..#
..#...#..#
#.####....
.##.......
.##......#
###..#.###

Tile 2713:
..#..#..#.
#.........
.#.....###
.#.##.#.##
.#.#.##...
.##..#.#.#
..####..#.
#..##.....
#....#....
.#..####..

Tile 2243:
#.##...##.
...#......
..#..#..##
....#....#
#....####.
.##.#...##
#..#..#...
#..###...#
#.##.#####
.#..#.###.

Tile 3307:
...####..#
....#.....
.###......
..#.......
.....#...#
#...#....#
#...#.....
.........#
#..###....
#####..#.#

Tile 2161:
###.#.#..#
#.#...###.
.##......#
##.#..#.#.
#.#.#..#.#
#..#.#....
...#....##
#.##...#.#
#......#..
..#.#.####

Tile 3257:
....##..##
#.........
..#..##.##
.#......#.
#...#....#
#.#...#.#.
....##...#
###....##.
.##...#..#
.#...#..##

Tile 1997:
..#.##.###
....#.....
..#......#
.#.#..#.#.
###...#.##
.#......##
..........
#........#
..#..#..##
##.#.#####

Tile 2741:
#####..###
#..#.....#
#...#...#.
....##...#
...#......
#..##.#...
###....###
........#.
##.###....
...#...###

Tile 2671:
##....#..#
........#.
.##.#..###
......##.#
#..#....##
....#...#.
#.#......#
###......#
...#......
..###.##.#

Tile 3943:
####...#.#
#..##.....
.#......#.
......##..
..#.....##
#...#....#
....##.#.#
..........
..#....#.#
..#.....##

Tile 1283:
..##...###
#..#....#.
#...#.....
.#.....##.
#.##....##
.#..#...#.
#....#...#
##....#...
.##...####
##..##.###

Tile 3067:
#.#.#.#.#.
#..#......
..##......
#..#...#.#
.##.#....#
......#...
#...#.#.##
.#..##..#.
...#...###
...##..#..

Tile 2957:
.#..###...
#........#
......#.##
...#..##.#
###....#.#
.....#..##
#.......#.
#....##.#.
......#.##
.##..#..##

Tile 1571:
..#...##.#
#..####..#
#.........
.#.###..##
#.....##.#
......#...
..#.......
.#........
........#.
####.#..##

Tile 1481:
#.#..##...
#...#....#
#.....#..#
..#......#
.#...#.#.#
....#..###
.#.###....
.....###..
.#....#..#
####..#..#

Tile 1637:
#.##...#..
.........#
#........#
.###.....#
##..#..#..
.#....#...
.......#.#
.....#....
#..##..#.#
#..###.#.#

Tile 1567:
####.#.#.#
...##.....
......#...
.#...##...
#.#....#.#
#.#......#
.###.....#
##..#..#..
...#......
########..

Tile 1117:
#..#.#.#.#
....#....#
.#.#..##..
....#.##..
##..#.....
...#......
#....#...#
...##..#.#
...#....#.
.#..#.##..

Tile 1663:
####..#...
#.#......#
......#...
....#..##.
#......#.#
...##....#
#........#
#.#..#...#
####.#....
..####.##.

Tile 3079:
.#....####
.#......#.
..........
......#..#
###..#.#.#
...#....##
..##.#####
..#.###..#
....##....
.#.######.

Tile 2011:
##.###....
..##.#.##.
##.##..#..
##.....##.
#...#...#.
.#.##.##.#
###..#.###
..#....#..
#.##..####
.......##.

Tile 1801:
.#..##..##
..#.###..#
....##....
#...#.#...
..##......
#.....#...
#.........
..##....##
#.#.#..#.#
..#.#..##.

Tile 1499:
...#..####
#.......#.
..........
#.....#..#
#..###....
#..#..##.#
...##.#..#
..#......#
..#.......
#.######..

Tile 1061:
###.#...##
#..###.##.
##.#......
#.#...#...
.....#..##
.#....#.#.
...#...#.#
...###....
.##..##.#.
#.#...#.##

Tile 1783:
#...####.#
#.....####
.#........
......##.#
..##....##
..#......#
#...#.#...
#........#
.#...#...#
.#######..

Tile 1301:
#.....#.##
#....#...#
#.##.#...#
.#..#.#..#
.#....#.#.
....##.##.
##..#...#.
.#...#.#..
...#.#....
..##......

Tile 1259:
#..###..##
....###..#
.#...#..#.
.....#...#
.#.##.....
#..#......
#.#.....#.
#...#....#
.....#.##.
#####...##

Tile 3823:
#..##..#..
#...#.....
.#.......#
#..#.##.#.
..........
#....#....
#.#.....##
..#.#.#...
..#......#
#..####.##

Tile 3181:
#.........
#......###
##....##..
......##.#
...#.##...
#.#..#...#
#.......#.
##...#....
#.....##.#
.####.####

Tile 3251:
...###.##.
...#.....#
##...#...#
#.####..##
...#.#..##
..#...#.##
##....#..#
.##.......
...#.#...#
..##..####

Tile 3121:
#..#....#.
#..##.#...
....#....#
#....#..#.
...#.....#
....#.....
.....#...#
...###...#
#..##...#.
.####.#...

Tile 3209:
##....#...
##.......#
.......#..
###.#...#.
..........
..#...#..#
..#.##..#.
##..#.....
#..####...
###..##..#

Tile 1049:
..#..#....
....##....
...#......
#...#.....
#..#.....#
...#.....#
.#.....##.
..#.#.##.#
..##.#.#.#
.##.###.#.

Tile 3671:
.###......
..###..#.#
....#.....
####......
#.#.#.....
#.......#.
..##...#..
.....#....
.##..#....
.##.#..##.

Tile 1171:
...###.##.
#.........
#.........
#........#
....##.#.#
#.....#..#
##..#.....
.......#..
...#.....#
.#####.###

Tile 3259:
###..##.#.
#..###..##
......##..
..#...#.#.
...#.#....
##....#..#
..#...##.#
.#....##..
........#.
.######...

Tile 1601:
#..#.#.###
......####
.#...##...
#......###
#...#....#
#....#.#.#
#...#..##.
..###.#...
#....##..#
.#.#..###.

Tile 2371:
.#.....#..
#.#..##...
.....#####
###..#.##.
#.####.#..
........#.
###......#
.........#
.......###
.##.###.#.

Tile 2153:
.#....#..#
#....#..##
#.........
.....##...
##.....##.
#.#......#
.#..##...#
##.#.#.#..
...#.....#
.#.##.##..

Tile 2269:
.#.#.#....
...#.....#
..#....#..
#.#.......
.#.#......
........##
..........
...#.....#
#.##...#.#
#.#....#..

Tile 1291:
##.##..#.#
##.#......
##..#.....
###...##..
.#..#.#..#
##...#...#
..#####...
###..####.
#.#......#
.#.#.##...

Tile 1487:
.##..##...
..#.#.##..
#...#...##
..#.#...#.
.###...#.#
..##.....#
...#.#...#
#.....#..#
#..#......
.##.#.####

Tile 3023:
########..
.#..#..#.#
###.###...
#.#......#
##.#.#..#.
.....#....
##..#.....
.##.......
.##......#
###..#...#

Tile 2887:
..#.#..#..
...#......
.......#.#
.......#..
#......#.#
#...#....#
..#....###
........#.
.#...#.##.
#.#..#.#..

Tile 2333:
#....##.#.
.#.......#
#....##..#
........##
#.........
..........
...##.#..#
#.#.#.....
.........#
###..#.##.

Tile 2311:
...####.#.
##.#......
#.#.......
#.##....##
...#.#..##
..#....#..
###.......
..#.##....
.#.###...#
#...###.##

Tile 1039:
.#..#.#.#.
....###...
##.......#
.##.......
..#......#
..........
#......#..
#....##..#
#.....#..#
..#.##..##

Tile 3571:
....#....#
#...#...##
##......##
..........
..#.......
.........#
...##.##.#
.#####....
.....#....
.#..#.....

Tile 2221:
##.#.###..
.###..#...
.#...#...#
#....#....
#..#.#....
#.#......#
#......###
..##.#....
#...###..#
#.##......

Tile 1361:
.#.#.#.#..
.##..##...
...##.....
#...##..##
##.##..#.#
...#..#...
#...#..#..
#........#
...#......
#..#...###

Tile 3637:
.#####...#
#........#
#..##.#.#.
#.........
#..##.....
.#....#...
...#....##
...###..#.
#....#.#..
##.#.#..##

Tile 3083:
.#....#.##
#....#....
#...#...#.
....#....#
.#.#..##.#
######..#.
#.###.....
.#........
#........#
###..###..

Tile 1619:
.###...##.
#....#...#
..#..#....
#...#.####
#.....#.#.
#..#......
..#..##..#
#..###....
#..#.#.#..
#..##..#.#

Tile 2063:
.#..#.....
#....#....
#..#.###..
#.#...#...
#....##.##
#...##..#.
#........#
..#...#...
...#..#...
#......#..

Tile 3911:
##..##....
##.......#
###....###
##.#.###.#
..#.......
#..#.#.###
.#.#.#.###
####..####
..##.##.#.
......#..#

Tile 2447:
#.......#.
##...##.#.
#.#..#...#
......###.
.#....#.##
..#...#..#
....#.#..#
#...#....#
..#.......
...##.#...

Tile 3191:
.#....#.#.
#..#...#.#
........##
....#..#..
#......#.#
#...##....
#......#.#
.##...#...
##....#...
#.####...#

Tile 1733:
..###..###
..........
#.##....#.
#..#...#.#
#..#.....#
..........
.........#
.......#..
#........#
.#.##.....

Tile 3533:
###.#...##
.........#
...##.#.#.
#........#
#..#...#..
.#.......#
#.#...#...
##.#..##..
#...##.###
...#.#.#.#

Tile 3767:
.######..#
##.#####..
....#.#...
#....##..#
.....#.#.#
#...#..#..
#...#...##
#.###.#..#
..........
#.#.#..#.#

Tile 2531:
.#.#...#..
....#....#
......#..#
#...#....#
##.......#
.#..####..
..##..#.##
#........#
#.....####
..##..####

Tile 3329:
##..#.##.#
....#...#.
##..#..#.#
##..#.#.##
...#...#..
.#####...#
...#....##
###...#...
..........
#######.##

Tile 2473:
##.#.####.
#.#.......
.......#.#
#.#.#.#...
....#..#..
#####....#
#..#..##..
#...#.....
.....#.#.#
##.#...##.

Tile 2851:
#......#..
#.#....##.
..........
#..##...##
#.#.#....#
#...#.....
#.#...##.#
##.#.#..##
#.#.......
##.##.....

Tile 2111:
#..###..#.
#...#.#.##
#.....#...
#.....####
#..##.#...
....##..#.
....#.....
...###.###
..#.#.....
#..#..#.##

Tile 3001:
..#.###...
......##..
..#...####
#..#.#....
##..#.....
..#.....##
.....##..#
.#.#..#..#
#.....#.##
..##......

Tile 2549:
.#..#..###
#..#.#.##.
.....#....
####..#..#
......#.#.
#.....#.#.
..........
##..#...##
...##....#
...###..#.

Tile 3989:
.......#.#
..##.#.###
#..##..#.#
..........
.#.##..#..
.....#...#
..#.#..###
.....###..
##...##...
.####.....

Tile 3049:
##...#####
###.#...##
#....#...#
#........#
#....#....
##..##..#.
..###.#..#
#.###.....
#...#.....
#.####.#.#

Tile 1721:
..###.#.##
#........#
.#.#...#.#
#.##.#.###
#..###..##
.....##..#
##.#.##..#
#......#.#
....##.#..
.#.......#

Tile 2791:
###.#.#...
#....#....
....##...#
...#.##.##
...#...#..
...###.##.
.#.#..#..#
##.##...##
.##..#.##.
#..##..###

Tile 2083:
#.#..#..##
.#....##.#
..#......#
#.........
....##...#
.......#.#
..###....#
###.....#.
###....##.
...#.#...#

Tile 3613:
.###.#..#.
#.#..##..#
#.###.#...
.#.....#.#
......#..#
......#...
.#.#...#.#
#.......##
......#..#
#..#.#.#..

Tile 1201:
..#.#...#.
#.....#...
#..##..#..
.#...#...#
#..##....#
#..#..#..#
.##.#..#.#
#..#......
...#..#...
#...##..##

Tile 3119:
#..#.##..#
#.#...#...
##....#.#.
#..#..#.##
#.........
...##..##.
#...#..#.#
#.........
#..#....#.
#.##.#.##.

Tile 2459:
.#....###.
....#.#...
#..#.#....
#...#..#..
#........#
.#.#......
....#...#.
#...#....#
..#.#.....
##.##..###

Tile 2341:
#..#..###.
#.#......#
#.#....#.#
##........
.#.##..#.#
.###......
.......#.#
##...#.#..
####...#.#
.#...###.#

Tile 3011:
###..#..##
...#.###..
#........#
.##.#...#.
.....#####
........##
.........#
#......#..
###.......
#..###.###

Tile 3727:
#.###..##.
#...#....#
...#....##
##..#....#
.........#
##..#.....
#.........
.##.......
#.##.###.#
#..#.#...#

Tile 2659:
#.##.###..
.........#
#...#..#..
.#..#.#...
....##...#
#..#.##...
#.##.....#
..........
...##..#..
#.##..#.#.

Tile 2657:
#...######
..#...#...
..#......#
...#...#..
......###.
#......##.
#..#..#..#
#.#.#..#..
.###..#...
#......###

Tile 2789:
#.....#..#
...#..###.
#.#.......
#........#
.#.#....#.
...#.....#
.#.....###
##.##....#
.##...#...
#####..#.#

Tile 1627:
#.##..#.##
#...##.#.#
....#....#
##..#...##
.....#...#
.#..#....#
........#.
#.#.###.##
.#.##.#..#
.#.###.#..

Tile 3167:
..###.#...
.....#..##
#..##.....
#.#..##.#.
#.....#.##
####.....#
#.###..#..
.##....#..
.#..#.....
#....#.#.#

Tile 3229:
###...#.##
##....##..
#.......##
...##....#
#.#.....#.
........##
##...#...#
#........#
..#......#
..#.....##

Tile 2383:
#.####.###
.#.#...#..
####..#.#.
.#..#.#..#
..#.#..#..
##.....#..
.....#.#.#
...##..#.#
##...####.
##...#.#.#

Tile 1381:
#.#.#.####
........##
.#..#..#..
#.....##..
.#...#.#.#
#.....#..#
...##..#..
..####....
##........
..######.#

Tile 3089:
..#..####.
.....#...#
.#........
.###..#.##
#..#.....#
#..##..#.#
##.....#.#
#...#.#...
.....#...#
...##.##.#

Tile 1229:
##..#....#
##.#.#...#
#...#..###
#.........
.......#..
...#.....#
#.#.......
..........
#...#.##..
.#...#####

Tile 3691:
.####.#.#.
#..#.##..#
.....#.###
#....#..##
##........
#...##.#.#
#.....#..#
..#.#.....
.##...##.#
#.##..#...

Tile 1019:
...##.#..#
#..#.....#
.........#
##..#..#..
#.....#...
#....#.#..
#.#..#....
#.#...#..#
##....#..#
.#.#####..

Tile 3217:
#.##..##..
#.#...###.
#.#....#.#
.#.#......
##.......#
...#.#..#.
##.#......
#.#.....##
.#........
.######...

Tile 2833:
....###.##
##........
....###...
....##....
.#.#......
..#...##.#
#.##....##
.###.#....
...##..#.#
.#.#....#.

Tile 1493:
...#.#.#.#
#.#..#....
#...#....#
.##......#
..#.##...#
#.........
.........#
##....#..#
#.#.......
.#.#..#..#

Tile 2963:
.##..#..##
#.#.....#.
#........#
#..#.#....
#........#
##....#..#
#.....##.#
###......#
.#....#...
......#..#

Tile 1873:
.###.#.#..
...##.....
#...#.....
.......#.#
.#.....#.#
...#....#.
..#..#....
##..#.#...
..#....###
#.##.#####

Tile 2539:
#..#...#.#
##.......#
#..#..#..#
......#.#.
..........
.###.#.##.
##.#.##..#
.......###
..#.###...
##.####...

Tile 2339:
#.###.#.##
#.....#..#
..........
#.........
......##.#
#..#.###.#
#.........
.......#..
.........#
...##.....

Tile 1303:
....##.###
#.#..#...#
.........#
#.....#.##
.#..#....#
.......#.#
...#....#.
#.####...#
.#.#....#.
##...#..#.

Tile 3539:
.#........
.#..#.##.#
###..##.##
....#....#
#......#..
#.###.#.##
.........#
..#...#.#.
##......#.
.#..#....#

Tile 1153:
#..##.#.##
#.#...#.##
#..##..#..
#..#..#..#
####.#.###
#...#...#.
#.....#...
#..##..#.#
.##.###.##
####.#.###

Tile 2273:
#.#....##.
###..####.
##....####
##.....#..
..#.....#.
....#...##
##........
.#.......#
#........#
.#..#.##.#

Tile 2543:
..###...#.
#..#..#...
####....#.
...###..#.
...#.#..##
###.#.....
#.........
##.....#..
..#...#...
..####...#

Tile 1451:
.#.####.##
.....#.#.#
.##.......
..#......#
...#.#..##
..#......#
#...##..##
#.#.......
#.........
#..#..#...

Tile 3203:
..###.....
#...#....#
###..##...
..........
###....#..
........##
...#......
#......##.
....#.#..#
.###.##...

Tile 1009:
..#.#..##.
##..#....#
#..##...##
##...#...#
##...#..#.
...#...###
....##.#..
....#.##.#
...##.####
....#.#...

Tile 1531:
.....#.##.
.#.####...
....##.#.#
#...#...##
#....##.#.
###......#
..#..##...
#..#.....#
..#....#.#
###.#..#..

Tile 3617:
.##.##.#.#
#....#..#.
.#....#.#.
#.........
.#...##..#
.##.#.##.#
#.#.#.##.#
.....###..
.#..#.##.#
.#.....##.

Tile 2617:
#..##.#..#
#..#....#.
.#.......#
#..#......
.###.####.
..#.....##
..#..#....
..#.......
....#.....
#....#####

Tile 1847:
..#.#...#.
.##....#..
###.#.##.#
..#.##..##
#####...#.
.###.#...#
#.......##
..#.#..#..
...##.#...
.###.#.##.

Tile 3299:
..#.##.##.
...##.....
#........#
...#.##.#.
.#####....
#..#.#..##
#..#..#.##
..#..#...#
#.#.#.....
.#...#..#.

Tile 2591:
......#.#.
#....#...#
##......##
...#...#..
..#.......
.....#.#.#
#.......##
..###...##
#..#..##.#
.....#.##.

Tile 3169:
###...##.#
..#..##..#
#..###...#
.#..#....#
..#......#
....#.#...
.##.#..###
..##...##.
###.......
##..#.####

Tile 3697:
..#.#.#..#
.###.#...#
#.##...##.
.#.##.#...
#..##....#
..........
#....#....
.##.......
#..#.#.##.
#.....#..#

Tile 2551:
#.##..#..#
#..#......
.#..#.....
#....#..#.
#.......##
.#..#....#
.#........
....#.....
.#.##.....
###.#.#...

Tile 2909:
.....#.#..
.#.#.....#
#....##...
#......##.
...#......
##.......#
......###.
#..#.##...
...#...##.
#.##...###

Tile 2027:
.#.#.####.
..##.....#
#...##.###
.##.#.....
##.##....#
....#.#...
#.##....#.
..###..#.#
#...#.#.##
##..#.##.#

Tile 3947:
#.#.#.##.#
.#........
#....##..#
#.........
.....#...#
......#...
#.#.##...#
.##.#.....
.........#
.###.#...#

Tile 3797:
#...####..
.#....##..
#.....#...
.....#.#.#
...#..##..
.....#...#
......##.#
.##...#...
.....##...
.#..#.#.#.

Tile 3187:
##...#..#.
#..#..#..#
#........#
......#.#.
......##..
#.#.......
#.#......#
##...#..##
##..#...##
####...#.#

Tile 1151:
..#..#..##
...#.#....
#.#.#....#
..#......#
...##....#
..#.......
#......#..
#.##..#...
#.#....###
######.#..

Tile 1511:
#...#.....
#.######.#
#.....#...
....#...#.
#..###.#.#
.....#.#.#
....#....#
#..#...##.
#........#
#....#.##.

Tile 2293:
##...#...#
#......#..
.#..#.....
#...###..#
##....#..#
#...##.#.#
....#.....
....#.....
#.....#.##
##.#.##.##

Tile 2131:
#.#..#.#..
#..#...#..
#.##..#...
....##..#.
#........#
#..#.....#
##.......#
####.#...#
.##..#.#..
###..#..#.

Tile 2711:
..###.....
..#.......
..##...##.
##..#..##.
.#...#....
.....#....
#...#....#
.##.#.#..#
#.##.#....
##.#..##.#

Tile 1543:
##.....##.
#...###...
...#.#..#.
#.#...#.##
.#.#.###..
####...###
#..##..#..
####..#.##
#.##...#..
...#..#.#.

Tile 1723:
.#####.###
....##....
##........
#.......#.
#..####..#
.####..##.
.#........
#..#..#...
..........
..#.#.##..

Tile 2819:
..#..##.##
.....#....
#.#.....##
..#.......
..##..#.#.
#....#...#
#...#...#.
..#.......
.........#
#.#..###..
`

var testInput = `
Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###...
`

type Tile struct {
	Name  int
	Edges Edges
	Tile  []string
}

func main() {
	ts := util.ReadInput(input, "\n\n")

	var tiles []Tile
	for _, t := range ts {
		l := strings.SplitN(t, "\n", 2)
		name, _ := strconv.Atoi(l[0][len("Tile ") : len(l[0])-1])
		tile := Tile{
			Name: name,
			Tile: strings.Split(l[1], "\n"),
		}
		tile.Edges = edgeIDs(tile.Tile)

		tiles = append(tiles, tile)
	}

	f, placement := first(tiles)
	fmt.Printf("first %d\n", f)
	fmt.Printf("second %d\n", second(placement))
}

func borderless(placement [][]Tile) []string {
	var m []string

	var wb [][][]string
	for _, row := range placement {
		var wbr [][]string
		for _, tile := range row {
			wbr = append(wbr, stripBorder(tile))
		}

		wb = append(wb, wbr)
	}

	for _, row := range wb {
		for k := 0; k < len(row[0][0]); k++ {
			var r strings.Builder
			for _, t := range row {
				r.WriteString(t[k])
			}
			m = append(m, r.String())
		}
	}

	return m
}

func stripBorder(t Tile) []string {
	var w []string

	for i, r := range t.Tile {
		if i == 0 || i == len(t.Tile)-1 {
			continue
		}

		var b strings.Builder
		for j, c := range r {
			if j == 0 || j == len(r)-1 {
				continue
			}

			b.WriteRune(c)
		}

		w = append(w, b.String())
	}

	return w
}

func second(placement [][]Tile) int {
	monsters := checkSeaMonsters(placement)

	return monsters
}

const seaMonster = `
                  #
#    ##    ##    ###
 #  #  #  #  #  #
`

func checkSeaMonsters(tiles [][]Tile) int {
	t := borderless(tiles)

	var monsters int
	for _, r := range [][]string{t, flip(t)} {
		for i := 0; i < 4; i++ {
			r = rotate(r)

			m := checkSeaMonster(r)
			if m > 0 {
				monsters = m
			}
		}
	}

	sea := 0
	for _, row := range t {
		for _, t := range row {
			if t == '#' {
				sea += 1
			}
		}
	}

	return sea - (monsters * 15)
}

func checkSeaMonster(t []string) int {
	sm := util.ReadInput(seaMonster, "\n")
	monsters := 0

	for y := range t {
		for x := range t[y] {
			hasMonster := true

			for my := range sm {
				for mx := range sm[my] {
					if rune(sm[my][mx]) != '#' {
						continue
					}

					posy := y + my
					if posy > len(t)-1 {
						hasMonster = false
						break
					}

					row := t[posy]

					posx := x + mx
					if posx > len(row)-1 {
						hasMonster = false
						break
					}

					if rune(row[posx]) != '#' {
						hasMonster = false
						break
					}
				}

				if !hasMonster {
					break
				}
			}

			if hasMonster {
				monsters += 1
			}
		}
	}

	return monsters
}

func rotate(l []string) []string {
	newlr := make([][]rune, len(l))
	size := len(l)
	for i, row := range l {
		coli := size - i - 1
		for j, c := range row {
			rowi := j
			if newlr[rowi] == nil {
				newlr[rowi] = make([]rune, len(l))
			}

			newlr[rowi][coli] = rune(c)
		}
	}

	newl := make([]string, len(l))
	for i, row := range newlr {
		newl[i] = string(row)
	}

	return newl
}

func flip(l []string) []string {
	newl := make([]string, len(l))

	for i, row := range l {
		newl[len(newl)-1-i] = row
	}

	return newl
}

func first(tiles []Tile) (int, [][]Tile) {
	size := int(math.Sqrt(float64(len(tiles))))
	placements := make([][]Tile, size)
	for i := range placements {
		placements[i] = make([]Tile, size)
	}

	canPlace, p := placeNext(placements, 0, 0, size, make(map[int]bool), tiles, Tile{})
	if canPlace {
		fmt.Printf("%d * %d * %d * %d\n", p[0][0].Name, p[0][size-1].Name, p[size-1][0].Name, p[size-1][size-1].Name)
		// for _, row := range p {
		// 	for k := 0; k < len(row[0].Tile[0]); k++ {
		// 		for _, t := range row {
		// 			fmt.Printf("%s ", t.Tile[k])
		// 		}
		// 		fmt.Println()
		// 	}
		// 	fmt.Println()
		// }

		return p[0][0].Name * p[0][size-1].Name * p[size-1][0].Name * p[size-1][size-1].Name, p
	}

	return -1, placements
}

func placeNext(placements [][]Tile, ri, ci, size int, used map[int]bool, tiles []Tile, tile Tile) (bool, [][]Tile) {
	if tile.Name > 0 {
		placements[ri][ci] = tile
		used[tile.Name] = true

		ci += 1
		if ci == size {
			ri += 1
			ci = 0
		}
		if ri == size {
			return true, placements
		}
	}

	var next []Tile
	for _, ot := range tiles {
		if _, ok := used[ot.Name]; ok {
			continue
		}

		for _, r := range []Tile{ot, ot.FlipH()} {
			for i := 0; i < 4; i++ {
				r = r.Rotate()

				fits := true
				if ri > 0 {
					up := placements[ri-1][ci]
					if up.Name > 0 {
						fits = fits && r.Edges.Up == up.Edges.Down
					}
				}
				if ri < size-1 {
					down := placements[ri+1][ci]
					if down.Name > 0 {
						fits = fits && r.Edges.Down == down.Edges.Up
					}
				}
				if ci > 0 {
					left := placements[ri][ci-1]
					if left.Name > 0 {
						fits = fits && r.Edges.Left == left.Edges.Right
					}
				}
				if ci < size-1 {
					right := placements[ri][ci+1]
					if right.Name > 0 {
						fits = fits && r.Edges.Right == right.Edges.Left
					}
				}

				if fits {
					next = append(next, r)
				}
			}
		}
	}

	if len(next) == 0 {
		return false, placements
	}

	for _, n := range next {
		nextp := make([][]Tile, size)
		for i := range placements {
			rowp := make([]Tile, size)
			copy(rowp, placements[i])
			nextp[i] = rowp
		}
		usedc := make(map[int]bool)
		for k, v := range used {
			usedc[k] = v
		}

		done, p := placeNext(nextp, ri, ci, size, usedc, tiles, n)
		if done {
			return true, p
		}
	}

	return false, placements
}

func (t Tile) Print() {
	for _, row := range t.Tile {
		fmt.Printf("%s\n", row)
	}
	fmt.Println()
}

func (t Tile) Rotate() Tile {
	newTileR := make([][]rune, len(t.Tile))
	size := len(t.Tile)
	for i, row := range t.Tile {
		coli := size - i - 1
		for j, c := range row {
			rowi := j
			if newTileR[rowi] == nil {
				newTileR[rowi] = make([]rune, len(t.Tile))
			}

			newTileR[rowi][coli] = rune(c)
		}
	}

	newTile := make([]string, len(t.Tile))
	for i, row := range newTileR {
		newTile[i] = string(row)
	}

	return Tile{
		Name:  t.Name,
		Tile:  newTile,
		Edges: edgeIDs(newTile),
	}
}

// flip over the horizontal axis
func (t Tile) FlipH() Tile {
	newTile := make([]string, len(t.Tile))

	for i, row := range t.Tile {
		newTile[len(newTile)-1-i] = row
	}

	return Tile{
		Name:  t.Name,
		Tile:  newTile,
		Edges: edgeIDs(newTile),
	}
}

type Edges struct {
	Up    int
	Right int
	Down  int
	Left  int
}

func edgeIDs(tile []string) Edges {
	strToNum := func(s string) int {
		s = strings.ReplaceAll(s, "#", "1")
		s = strings.ReplaceAll(s, ".", "0")
		n, _ := strconv.ParseInt(s, 2, 64)
		return int(n)
	}

	var edges Edges

	// up
	edges.Up = strToNum(tile[0])

	// bottom
	edges.Down = strToNum(tile[len(tile)-1])

	// left
	var b strings.Builder
	for _, s := range tile {
		b.WriteByte(s[0])
	}

	edges.Left = strToNum(b.String())

	// right
	b.Reset()
	for _, s := range tile {
		b.WriteByte(s[len(tile)-1])
	}

	edges.Right = strToNum(b.String())
	return edges
}
